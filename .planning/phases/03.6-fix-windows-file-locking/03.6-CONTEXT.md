# Phase 03.6: Fix Windows File Locking - Context

**Gathered:** 2026-01-30
**Status:** Ready for planning

<domain>
## Phase Boundary

Fix the `[WinError 32] The process cannot access the file because it is being used by another process` error that occurs during batch transcription on Windows. This is caused by multiple processes or libraries (Lhotse/NeMo) attempting to access the same temporary manifest file simultaneously without proper closing/releasing.

</domain>

<decisions>
## Implementation Decisions

### Temp File Handling
- **Manual Management:** Avoid `NamedTemporaryFile(delete=True)` on Windows because it keeps the file open, preventing other processes (like subprocesses spawned by libraries) from opening it.
- **Pattern:** Use `NamedTemporaryFile(delete=False)`, close it immediately after writing, pass the path to consumers, and explicitly unlink (delete) the file in a `finally` block.

### Manifest Strategy
- **File-based with Proper Cleanup:** Continue using file-based manifests if the library requires a file path (common in ML libraries like NeMo/Lhotse).
- **Unique Paths:** Ensure manifest paths are unique per job/file to prevent cross-job contamination, though sequential processing (Phase 03.5) helps here.

### Error Recovery
- **Retry with Backoff:** If a file lock error occurs, attempt a short backoff and retry (e.g., 3 attempts) before failing. Windows file locks can be transient (antivirus, indexer).
- **Fail Fast on Persistent Lock:** If retries fail, mark the file as failed with a clear "File Access Error" message rather than crashing the batch.

### Claude's Discretion
- **Library Internals:** If the error comes from deep within a library (NeMo) managing its own temp files, we may need to monkey-patch or configure the library to use a specific temp directory we control.

</decisions>

<specifics>
## Specific Ideas

- "Fix the race condition causing `The process cannot access the file because it is being used by another process`."
- "Ensure temporary files are closed/released before being accessed."

</specifics>

<deferred>
## Deferred Ideas

None â€” discussion stayed within phase scope.

</deferred>

---

*Phase: 03.6-fix-windows-file-locking*
*Context gathered: 2026-01-30*
